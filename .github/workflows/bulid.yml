name: CI/CD

on:
 push:
  branches:
   - master

jobs:
 build-and-deploy:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout code
    uses: actions/checkout@v2

   - name: Build Docker image
    run: docker build -t my-app .

   - name: Run tests
    run: python -m unittest discover -s app/tests

   - name: Login to Docker Hub
    uses: docker/login-action@v1
    with:
     username: ${{ secrets.DOCKER_USERNAME }}
     password: ${{ secrets.DOCKER_PASSWORD }}

   - name: Push Docker image to Docker Hub
    run: docker push ${{ secrets.DOCKER_USERNAME }}/my-app

   - name: Login to Heroku
    uses: actions/heroku/login@v1
    with:
     heroku_api_key: ${{ secrets.HEROKU_API_KEY }}

   - name: Deploy to Heroku
    uses: actions/heroku/deploy@v1
    with:
     app: my-heroku-app
     dockerfile: Dockerfile
     source: ${{ secrets.DOCKER_USERNAME }}/my-app
